# Neverthrowã®ç·´ç¿’ç”¨ãƒªãƒã‚¸ãƒˆãƒª


throwã«ã‚ˆã‚‹å¤§åŸŸè„±å‡ºã‚’é¿ã‘ã¦å®‰å…¨ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’æº€å–«ã™ã‚‹ãŸã‚ã«å½¹ç«‹ã¤Neverthrowã§ã™ãŒã€æ…£ã‚Œã‚‹ã®ã«å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã¨ã„ã†æ„è¦‹ã‚‚ã‚ã‚Šã¾ã™ã€‚  
æœ¬ãƒªãƒã‚¸ãƒˆãƒªã§ã¯TypeScript + jestã§ç·´ç¿’ã—ã‚„ã™ã„ç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºè€…ãŒNeverthrowã«æ…£ã‚Œã‚‰ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¾ã™ã€‚  

## ã•ã„ã—ã‚‡ã«

ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«ãŠã„ã¦ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã§ãã‚‹ã ã‘å¿ å®Ÿã«ã‚³ãƒ¼ãƒ‰ã«è½ã¨ã—è¾¼ã‚€ã“ã¨ã§ã€é•å’Œæ„Ÿã®ãªã„ç†ã«ã‹ãªã£ãŸã‚³ãƒ¼ãƒ‰è¨­è¨ˆãŒã§ãã¾ã™ã€‚  
ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã‚³ãƒ¼ãƒ‰ã«è½ã¨ã—è¾¼ã‚€éš›ã«é‡è¦ã«ãªã‚‹ã‚‚ã®ã®ä¸€ã¤ã«ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã€ãŒã‚ã‚Šã¾ã™ã€‚  
ãŸã¨ãˆã°ã€Xã§ã¯ãƒã‚¹ãƒˆã«å¯¾ã—ã¦ãƒªãƒ—ãƒ©ã‚¤ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ã¤ã¾ã‚Šã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–äººã®ãƒã‚¹ãƒˆã«å¯¾ã—ã¦ãƒªãƒ—ãƒ©ã‚¤ã™ã‚‹ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```ts
/**
 * ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸Šã®åˆ¶ç´„ã§ç™ºç”Ÿã—ãŸä¾‹å¤–ã®ã‚µãƒ³ãƒ—ãƒ«
 * ãƒªãƒ—ãƒ©ã‚¤ã‚’åˆ¶é™ã•ã‚ŒãŸæŠ•ç¨¿ã«å¯¾ã—ã¦ã€ãƒªãƒ—ãƒ©ã‚¤ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ç™ºç”Ÿã™ã‚‹
 */
class NotPermittedToReply extends Error {
  constructor(message = "ã“ã®æŠ•ç¨¿ã«ã¯ãƒªãƒ—ãƒ©ã‚¤ã§ãã¾ã›ã‚“") {
    super(message);
  }
}
```

ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¹ãƒˆã«å¯¾ã—ã¦ãƒªãƒ—ãƒ©ã‚¤ã™ã‚‹ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã¯ã©ã®ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ï¼Ÿ  
ã§ãã‚‹é™ã‚Šå˜ç´”åŒ–ã—ã¦æ›¸ã„ã¦ã¿ã¾ã™ã€‚  

```ts
async function replyToPost(postId: string, replierId: string, replyMessage: string) {
  const post = await getPostById(postId);
  const repliedPost = post.reply(replierId, replyMessage);
  await savePost(repliedPost)
  // ã‚ã‚Œã€NotPermittedToReplyã¯ã©ã“ã§ç™ºç”Ÿã™ã‚‹ã®ï¼Ÿï¼ŸğŸ¤¯
}
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€å®Ÿã¯ `post.reply` ã‚’å®Ÿè¡Œã™ã‚‹ã¨å‰è¿°ã® `NotPermittedToReply` ãŒæŠ•ã’ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚  
ã—ã‹ã—ã€ãã®ã“ã¨ã¯ `Post` ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã‚’è¦‹ãªã„ã¨æ˜ã‚‰ã‹ã§ã¯ãªãã€TypeScriptã®å‹ã‚·ã‚¹ãƒ†ãƒ ã§ã¯è£œè¶³ã§ãã¾ã›ã‚“ã€‚  

```ts
class Post {
  public reply(replierId: string, replyMessage: string) {
    // ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—å¾—ã‚‹ã“ã¨ãŒå‘¼ã³å‡ºã—å…ƒã‹ã‚‰ã¯ã‚ã‹ã‚‰ãªã„ğŸ˜•
    if (...) {
      throw new NotPermittedToReply()
    }
  }
}

async function replyToPost(postId: string, replierId: string, replyMessage: string) {
  const post = await getPostById(postId);
  // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—å¾—ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸä¸Šã§ã€try catchã‚’æ›¸ã‹ãªã„ã¨ã„ã‘ãªã„ğŸ˜•
  try {
    const repliedPost = post.reply(replierId, replyMessage);
  } catch (e) {
    if (e instanceof NotPermittedToReply) {
      // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã«å¿œã˜ãŸå‡¦ç†ãŒå¿…è¦ã§ã‚ã‚Œã°ã“ã“ã«è¨˜è¼‰ã™ã‚‹
    }
  }
  await savePost(repliedPost)
}
```

ç´ æ—©ãã€é©åˆ‡ã«ä¾¡å€¤ã‚’å±Šã‘ã‚‰ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’æ§‹ç¯‰ã—ã¦ã„ããŸã„é–‹ç™ºè€…ã«ã¨ã£ã¦ã€é ­ã‚’æ‚©ã¾ã›ã‚‹èª²é¡Œã§ã™ã€‚  
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ç‰¹åˆ¥ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã«ã€500ã‚¨ãƒ©ãƒ¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ã—ã¾ã£ã¦åˆ¤æ–­ã§ããªããªã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚ˆã‚Šæ‚ªã„ã‚±ãƒ¼ã‚¹ã§ã¯ã€é–‹ç™ºç’°å¢ƒã§ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸¸ã‚è¾¼ã¾ã‚Œãªã„ã‹ã‚‰ã¨ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚‚ã¨ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å‡¦ç†ã‚’æ›¸ã„ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚é–‹ç™ºç’°å¢ƒä»¥å¤–ã§ã¯æ­£å¸¸ã«å‹•ãã¾ã›ã‚“...æ€–ã„ã§ã™ã­ã€‚  
ã“ã†ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã‚‹å¯èƒ½æ€§ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ãŸã‚ã®æ‰‹æ³•ã¨ã—ã¦ã€Resultå‹ãŒã‚ã‚Šã¾ã™ã€‚  

Resultå‹ã¯é–¢æ•°å‹è¨€èªã§å¥½ã‚“ã§åˆ©ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ã§ã€æœ€è¿‘ã§ã¯Rustã§æ¡ç”¨ã•ã‚Œã¦æ³¨ç›®ã‚’æµ´ã³ã¦ãŠã‚Šã€ã”å­˜ã˜ã®æ–¹ã‚‚å¤šã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚  
TypeScriptã§ã“ã®Resultå‹ã‚’å®Ÿç¾ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã²ã¨ã¤ã«ã€NeverthrowãŒã‚ã‚Šã¾ã™ã€‚  
ã“ã®Neverthrowã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’ã†ã¾ããƒ¢ãƒ‡ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ä¸€æ–¹ã§ã€ã“ã‚Œã¾ã§Resultå‹ã‚„é–¢æ•°åˆæˆã®çµŒé¨“ãŒå…¨ããªã„ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‹ã‚‰ã™ã‚‹ã¨ã€ã™ã“ã—é›£è§£ã§ã‚ã‚‹ã¨ã„ã†æ„è¦‹ã‚‚ã‚ã‚Šã¾ã™ã€‚  
ç§ã¨ã—ã¦ã¯Neverthrowã¯é–¢æ•°å‹è¨€èªã®çµŒé¨“ãŒãªãã¦ã‚‚Resultå‹ã‚„é–¢æ•°åˆæˆã®æ©æµã«ä¸ã‚Œã‚‹å„ªã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã ã¨æ€ã£ã¦ãŠã‚Šã€ã‚ˆã‚Šå¤šãã®äººã«ä½¿ã£ã¦ã‚‚ã‚‰ã„ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚  

```ts
// Neverthrowã‚’ä½¿ã£ãŸä¾‹
// ä¸‹è¨˜ã®å®Ÿè£…ã§ã¯Resultå‹ã‚’åˆ©ç”¨ã—ãŸé–¢æ•°åˆæˆã‚’è¡Œã£ã¦ã„ã‚‹
// é€”ä¸­ã®é–¢æ•°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å¾Œç¶šå‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã€ã‚¨ãƒ©ãƒ¼ãŒè¿”å´ã•ã‚Œã‚‹
// TypeScriptã®å‹å®šç¾©ã¨ã—ã¦ã‚‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—å¾—ã‚‹ã“ã¨ãŒè¡¨ç¾ã•ã‚Œã‚‹

class Post {
  public reply(replierId: string, replyMessage: string) {
    if (...) {
      // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’throwã›ãšã«ã€Resultå‹ã®ã‚¨ãƒ©ãƒ¼å‹ã¨ã—ã¦Returnã™ã‚‹
      return Err(new NotPermittedToReply())
    }
  }
}

function replyToPost(postId: string, replierId: string, replyMessage: string) {
  return getPostById(postId).map(
    (post) => ({
      post,
      replierId,
      replyMessage
    }))
    // ã‚‚ã—ã“ã®ä¸­ã§ã‚¨ãƒ©ãƒ¼ãŒè¿”å´ã•ã‚ŒãŸå ´åˆã€savePostã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã‚¨ãƒ©ãƒ¼ãŒãã®ã¾ã¾è¿”å´ã•ã‚Œã‚‹
    .andThen(post.reply)
    .andThen(savePost)
}
```

Neverthrowé–¢é€£ã®æƒ…å ±ã¸ã®ãƒªãƒ³ã‚¯
- [NeverThrow ğŸ™…](https://github.com/supermacro/neverthrow)
- [neverthrow ã®å…¨æ©Ÿèƒ½ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://zenn.dev/akineko/articles/3d366bb1fb26f8)
- [ã€TypeScriptã€‘try-catchã¯ã‚‚ã†ä¸è¦ï¼ï¼ŸNeverThrowã‚’ä½¿ã£ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](https://nakamuuu.blog/typescript-how-to-use-neverthrow/)


## ä½¿ã„æ–¹

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« `pnpm install` 

DB(sqlite3)ã®æº–å‚™ `pnpm migrate` 

jestãŒå‹•ãã“ã¨ã®ç¢ºèª `pnpm test`


`trainings` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«ç·´ç¿’ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚  

- [001-result.spec.ts](./src/trainings/001-result.spec.ts)
- [002-map.spec.ts](./src/trainings/002-map.spec.ts)
- [003-mapErr.spec.ts](./src/trainings/003-mapErr.spec.ts)
- [004-andThen.spec.ts](./src/trainings/004-andThen.spec.ts)
- [005-orElse.spec.ts]
- [006-match.spec.ts]
- [007-combine.spec.ts]
- [008-combineWithAllErrors.spec.ts]
- [009-okAsync.spec.ts]
- [010-errAsync.spec.ts]
- [011-asyncAndThen.spec.ts]
- [012-fromThrowable.spec.ts]
- [013-fromSafePromise.spec.ts]
- [014-fromPromise.spec.ts]


